# RTS Decomposed

## основные механики и понятия

**Общие механики, присутствующие в большинстве существующих RTS, которые в любом случае надо реализовать.**

**Игровое пространство.** В любой игре есть пространство, в котором происходит действие. В нашей игре тоже есть ландшафт, по которому передвигаются юниты. К игровому пространству относится и туман войны.

**Ресурсы.** Основа экономической части игры. Различные ресурсы добываются или генерируются, накапливаются и расходуются по ходу развития. Принципиально отличающийся ресурс - время. Все остальные с помощью нескольких параметров можно причесать под одну гребенку.

**Юниты.** Интерактивные объекты игрового мира. На самом деле нет принципиальной разницы между зданием и юнитом, поэтому здания тоже можно отнести в эту категорию. Юниты и их возможности - это, пожалуй, одна из двух самых обширных механик, так как включает в себя множество подмеханик, таких как движение, строительство, смена состояний, бой и так далее. Я утверждаю, что есть сравнительно небольшой набор параметров и подмеханик с их собственными параметрами, такой, что этим набором можно функционально описать большинство юнитов и зданий в большинстве существующих стратегий.

**Исследование.** Вторая обширная механика, не столько по объему, сколько по сложности. Основная ее цель - создать пространство, в котором игрок мог бы выбирать и управлять вектором развития своих технологий, получая за это новые юниты, улучшения и здания. Исследования должны иметь достаточную вариативность, чтобы игра оставалась разной при повторных прохождениях, но при этом должня быть достаточно сбалансированы, чтобы не выдавать вундервафли через раз. Принципиальное требование к исследованиям в этой игре - это невозможность исследовать всё. То есть дерево исследований бесконечное. Естественно, это НЕ способ сохранять интерес к игре. Это способ заставить игрока делать то, что ему действительно нужно. Грубо говоря, если у тебя в некоторой игре есть город, и там только пять открытых домов, то игрок обшарит их все и скажет "а чо так мало". А если в городе тысяча открытых домов, и все разные, игрок обшарит 5, обшарит 10, а потом скажет "вот это ШВОБОДА!" и пойдет делать то, что ему реально интересно, потому что поймет, что все дома он все равно не обшарит. Короче, это способ исключить тупой перебор и заодно отвадить игрока от принципа двенадцати огурцов: "так, щас короче исследую все технологии, и максимальным стеком топовых юнитов набигу".

**"Уникальные" механики на будушее, которые встречаются в относительно малом количестве игр:**
Это, опять же, просто идеи. Это не то, что я буду делать прямо завтра.

**Сокрытие данных.** Игра про исследование и сюрпризы. В обычной стратегии ты точно знаешь все про свой юнит. В этой игре знания о своем юните надо заработать. Если ты только-только изобрел новый танк, будет неплохо обкатать небольшую партию и посмотреть на него в бою. Только дурак будет после первого опытного образца сразу заказывать сто штук и бросать их в бой. Еще раз: мой концепт - не старкрафт, он антистаркрафт, и это нормально.

**Шпионаж.** Выдача некоторых сведений о некоторых юнитах или действиях противника. Является заменой практике "знакомства" в шутерах, когда на тебя сначала набегает один монстр, чтобы ты с ним потренировался и понял его тактики и возможности, а потом уже на тебя бежит толпа. И является заменой многократного реплея в стратегиях. Поскольку у нас каждый раз разные юниты, то знание о том, что у противника только что появился новый юнит с какими-то параметрами может дать подсказку по поводу того, что надо сделать дальше. Естественно, это не обязательно - всегда есть ручной шпионаж, когда ты посылаешь условный трайк в место предполагаемого сбора войск, и узнаёшь, сколько там кого, кто там чем и насколько далеко стреляет. Расширение этой механики может быть (очень условно) следующим: убиваешь 5 "танков" - узнаешь подробно их статы. Убиваешь еще пять - получаешь бонус в исследовании связанной технологии. Убиваешь еще 10 - можешь производить такие же.


### Карта (территория)
На самом деле это достаточно сложный элемент. При первом рассмотрении он кажется элементарным - хуяк-хуяк, море-дерево-поле-куст, поехали. Но если копнуть глубже, возникают некоторые концептуальные вопросы, и надо уметь вовремя остановиться.

Начнем с того, игровое пространство можно разделить на два типа: ландшафт и зоны. Ландшафт - основная сущность пространства: в каждой точке есть какой-то ландшафт, и он только один. Ландшафт связан с физическим строением территории. Можно сказать, что ландшафт определяет меш того, на чем происходит игра. Область же является просто дополнением. Областей в данной точке может быть от нуля до бесконечности, это просто некоторое свойство пространства. В дюне ландшафт - это песок, камень и скалы. В they are billions это земля, вода и горы. Примеры областей - зона строительства в they are billions, поле пилонов или крип в старкрафте, тибериумные поля в c&c.


Некоторые важные свойства ландшафта и областей:

- Ландшафт не имеет свойств, он имеет типы, и на эти типы по разному реагируют разные юниты. Реакция на ландшафт - свойство юнита, не ландшафта.
- Области имеют эффекты, которые они накладывают на юнитов. Эффект области - свойство области, не юнита.
- Области могут пересекаться, каждая точка карты может принадлежать одновременно нескольким областям (залежи железной руды в химически зараженном поле)
- Ландшафт всегда имеет визуальное представление. Область может иметь визуальное представление (пшеничное поле), а может и не иметь (радиоактивное заражение)
- Области могут изменяться как по внутреннему содержанию (руда добывается, область становится беднее), так и по физическим размерам (крип ползет, заражение распространяется, лес вымирает)

С точки зрения данных область можно хранить как набор тайлов (руда в factorio занимает определенные координаты, и у каждой "рудинки" в координатах есть количество руды). В игре с непрерывным пространством это может быть геометрическая область или просто density map определенного фрагмента карты.

Сложность начинается, когда мы пытаемся провести границу и понять - "гора с залежами железа" в rimworld - это ландшафт или область? Исходя из здравого смысла - ландшафт. Но исходя из механик - это вообще юнит, потому что у него есть хитпоинты, ландшафт на такие мелочи не разменивается, а области слишком нематериальны, чтобы их можно было уничтожать.

В общем, к этому разделу надо будет еще раз вернуться после юнитов, особенно в контексте преодоления преград. Я пока не могу никак без костылей вписать в эту механику колоссов из второго старкрафта. 

### Ресурсы

Ресурсы - основа экономики. Есть уникальный ресурс - время. Он настолько отличается от остальных, что во всех упоминаниях идет особняком. Но все остальные живут примерно по одним и тем же правилам.


- Ресурсы делятся на два типа: исчерпаемые (руда, вода, загрязнение) и неисчерпаемые (солнечная энергия, вода в океане, мировой эфир, whatever). Добыча исчерпаемых ресурсов "переносит" их из одного места в другое, добыча неисчерпаемых ресурсов просто генерирует их "из ничего".
- Ресурсы также делятся еще на два типа: накапливаемые и ненакапливаемые. В they are billions накапливаемые - золото, ненакапливаемые - энергия или еда.
- Возможно, ресурсы делается еще на два типа: счетные и несчетные. Но тут я пока не могу придумать внятного примера применения. Вероятно, это можно заменить механикой областей.
- Исчерпаемый ресурс может быть свойствм области или юнита
- Есть общеигровое хранилище ресурсов

Дальше можно закопаться очень глубоко, уходя в дебри экономических и производственных стратегий, типа settlers или factorio - конвертация ресурсов, протухание ресурсов, множество складов, но в это мы пока углубляться не будем. Нам важно сделать примерный outline самого основного.

### Юниты

Довольно интересным осознанием для меня стало то, что между зданием и боевой единицей разницы по сути нет. Геймплейно разница по большей части выражается в том, что здание мы выставляем на карту *до* завершения постройки, а боевую единицу - *после*. В остальном они достаточно сильно смешиваются. Юнит ли разложенный осадный танк, или здание? Юнит ли летящий терранский командный центр? Юнит ли MCV до того, как его разложили? Или это просто construction yard в режиме грузовика?

- нет принципиальной разницы между зданием и боевой единицей
- каждый юнит _может_ реализовывать следующие базовые механики (и возможность реализации той или иной механики записана в его конфигурации)
	- взаимодействие с пользователем (мои могут, нейтральные не могут)
	- движение
	- производство
	- исследования
	- переключение режимов 
	- наложение эффектов при изменении состояния
	- бой

#### Режимы
По сути, режимы - это состояния юнита. Набор всех режимов - конечный автомат, между состояниями которого мы можем переключаться. Вероятно, постройка и гибель тоже являются состояниями этого автомата, и могут иметь связанные эффекты. Причем некоторые эффекты вполне могут переключать состояния.

- юнит может иметь несколько переключателей, и каждый переключатель может иметь несколько режимов (осадный режим танка, режим невидимости призрака)
- у каждого режима свой набор параметров. Фактически, юнит с двумя режимами - это два разных юнита. (копирование + изменение минимума параметров при процедурном создании нового режима, чтобы минимизировать разброс!)
- режимы могут переключаются независимо друг от друга, но некоторые режимы одного переключателя могут блокировать другие переключатели
- переход из одного режима в другой может требовать ресурсов (в том числе времени). Но может быть моментальный+бесплатный.
- процесс перехода из одного режима в другой может активировать эффекты.

_сложности - конфликты значений для параллельных режимов. вариант - запрещать изменять одни и те же значения разными переключателями_

#### Эффекты

Эффект - одна из самых важных механик, добавляющих гибкость. Эффект - это задача игровому движку на то, чтобы он в определенной области произвел определенные действия с параметрами определенных юнитов. Эффекты могут содержать эффекты, накладывать другие эффекты, и так далее. По сути эффект - это квант взаимодействия между юнитами. Пуля, летящая в цель, несет эффект "физический урон" количеством 25 тому, в кого попадет. Тибериумное поле несет эффект "химический урон" количеством 5 каждую секунду всем юнитам в радиусе 1 клетки от себя. Пси-шторм, ярость топора, невидимость арбитра - все это эффекты.


- Каждый юнит может создавать и накладывать любое количество эффектов, как в результате атаки, смены режима, смены состояния, так и просто без причины. Естественно, это все прописано в карточке юнита, это не означает, что каждый юнит каждый такт будет накладывать рандомный эффект на все вокруг.
- Каждый эффект с указанной вероятностью изменяет в указанных пределах указанные параметры юнитов, попадающих под его действие. Это в том числе позволяет реализовать сбор или генерацию ресурсов.
- Эффекты одного типа могут стекаться, если это указано в описании эффекта
- Эффекты могут быть одноразовыми (пуля в лоб) и протяженными во времени (кислотный ожог)
- Эффекты могут накладывать другие эффекты (если полить водой робота, то в течение 10 секунд он не будет получать никакого урона непосредственно от воды, но каждую секунду будет иметь возможность с вероятностью 1% получить эффект "короткое замыкание"). Пример надуманный, но он для демонстрации возможностей, а не потому что я правда собираюсь поливать роботов из брандспойта.

_здесь надо придумать такую структуру эффекта, чтобы она позволяла реализовать простейшие механики (сбор ресурсов, пара видов атаки), для самого первого PoC, но чтобы это не стало проблемой в будущем_

#### Бой
- Каждый юнит имеет _оружие_ (одно для каждого состояния? пока да)
- _оружие_ генерирует "выстрел"
	1. Выстрел - новый юнит (ракеты, мины, медленный плазменный дробовик, whatever). При коллизии срабатывают эффекты (которые, как правило, разрушает снаряд и наносят ущерб цели)
	2. Выстрел - непосредственное наложение эффекта сразу на цель или область (пси-шторм)
	3. Выстрел - линейный коллайдер (лазер, пулемет - пренебрегаем временем путешествия пули)
	4. ??? В данной схеме огнемет можно реализовать как либо создание "снаряда" огня, медленно летящего в конусе от огнемента, либо создание эффекта "поражение огнем" в конусовидной области перед юнитом.
- Выстрел воздействует согласно своему набору эффектов на область попадания
- Выстрел может иметь ограничение по движению (угол коллайдера к горизонту, дальность, для "ракет" - расстояние и высота). Этой механикой можно реализовать воздух-земля, земля-воздух и все такое. Здесь нужно подробнее посмотреть на total annihilation.
- Выстрел может стоить какого-то количества ресурсов, либо быть бесплатным. (время - тоже ресурс, эта механика реализует перезарядку)

_моментальные сложности - ограничение количества "выстрелов-юнитов". напрмиер, если "патрон" не уничтожается при попадании в цель, а остается на месте и генерирует вокруг себя ядовитое поле, причем у него самого к этому полю иммунитет. При высокой скорострельности я могу "засеять" всю карту такими патронами движок охуеет все считать.
Френдли файр может стать проблемой._

#### Производство
- по указанию юзера в очередь производства родительского юнита добавляется задача
- в момент начала выполнения задачи снимается определенная сумма всех необходимых ресурсов
- по выполнении этой задачи создается новый юнит

_Здесь надо подумать о том, какую действительно разницу имеют здание и машинка. Только ли во времени планирования?_

#### Исследование
Глобальная идея - сделать теоретические исследования для качественных скачков, и прикладные исследования для количественных. У количественных будет некоторый предел (чтобы ты не мог бесконечно улучшать каменное копье). Качественные будут открывать доступ к новым количественным.

Пока что я думаю о нескольких вариантах представления научного прогресса:

1. n-мерное пространство "гранита науки", в котором ты выгрызаешь какие-то пути, и иногда находишь спрятанные "алмазы" открытий. Вопросы: какие параметры отложены по осям, чтобы картина была осмысленной? Как управлять "выгрызанием", чтобы это было не заебно (особенно, если измерений больше двух)? Стоит ли вообще привязывать параметры к осям? Есть ли препятствия на твоем пути, однороден ли "гранит науки"? Есть вариант раскидать по полю "центры приятжения". Например, есть центр притяжения скорости атаки, и чем ближе ты к нему, тем, до какого-то предела, быстрее атаки твоих юнитов. Количественные изменения ты получаешь, роясь между известными центрами, качественные - открывая новые центры.
2. стандартный граф технологий, генерируемый динамически по ходу или целиком перед игрой. Вопросы: как достичь экстенсивной бесконечности исследований (чтобы все не выродилось в бесконечное улучшение одного юнита вглубь по ветке)? Как лучше осуществить объединение веток, смежные и комбо-технологии? Есть желание заставить игрока жертвовать ветками. То есть я не ставлю целью сделать игру, где ты не можешь исследовать все технологии, потому что у тебя бесконечная цепочка из "новые технологии 1", "новые технологии 2" и так далее, а потому что у тебя в каждый момент много вариантов, и ты должен выбирать ветки, по которым ты движешься, бросать бесперспективные исследования и все такое. Но тут сложность в том, как строить такой граф с учетом вышеозвученной идеи теория/практика. Можно сделать 3д: по вертикали уровни технологического роста, на каждом уровне от центральных "жил" отходят обычные плоские графы технологий.
3. Гексагональный лабиринт. Есть плоскость гексов, есть стартовая точка, из которой ты можешь "исследовать" соседние гексы. У ближайших гексов больше информации о том, что они могут дать, у более далеких - меньше. В целом ты видишь примерные прогнозы в радиусе 3-4 гексов пути вокруг себя. При этом ты не видишь те гексы, до которых не можешь дойти из-за стенок между ними. Стенки нужны для ограничения "количественного" развития. Качественное развитие можно стимулировать открытием новых точек на этой плоскости, из которых тоже можно куда-то выходить. По сути это первый вариант, но с дискретным двумерным простарнством технологий. Плюс в том, что гораздо более ясно, что происходит.

## Потенциальные возможности
Что можно попробовать сделать на таком наборе механик (не то, ради чего они создаются, а то, что можно попробовать просто потому, что можно)

- Биологическая война
- Экономическая диверсия - уничтожение ресурсов
- Условный терраформинг (генератор леса, генератор гор)

## Немного конкретики
Попробуем описать конкретный список параметров области, эффекта и юнита. Попробуем на этом списке параметров сгенерировать достаточно разнообразные здания и боевые машины, а так же простейшую экономическую механику сбора ресурсов. Если это окажется возможным, то следующий шаг - реализация пруф оф концепта с такими юнитами и раздумия по поводу того, как настроить генератор таким образом, чтобы он не генерировал шлак.

В начале списка описаны шаблоны. Типы абстрактные и не привязаны к конкретному языку. С маленькой буквы - примитивы, с большой - объекты или структуры. В квадратных скобках - индексные массивы, в фигурных - ассоциативные.

Чтобы особо дотошные кирилловеды меня не обвинили в наполеоновских планах, сразу скажу, что пруф оф концепт я начну максимум процентов с 25 от описанного внизу. Но всегда лучше иметь на руках полную картину, чтобы не укусить себя за яйца в самый ответственный момент.

Вкратце, напоминаю, что у нас есть и как это работает:

**Ресурсы** - создаются и уничтожаются, в промежутке могут храниться в юнитах и областях.

**Области** - области на ландшафте с определенными свойствами и эффектами воздействия на то, что находится внутри них.

**Эффекты** - гибко настраиваются и изменяют указанные характеристики объектов, попадающих под их действие. Эффекты могут быть привязаны почти ко всем игровым событиям и являются основой большинства игровых механик.

**Юниты** - все объекты в игре, которые не являются ландшафтом и областями. Юнит - конечный автомат своих состояний, каждое состояние представляет набор характеристик юнита. Юнит может содержать ресурсы в своем внутреннем хранилище, может иметь одно или несколько оружий, каждое оружие при выстреле либо накладывает эффект(ы) непосредственно на цель, либо создает юниты-"снаряды", которые, как правило, настроены существенно проще родительских юнитов и не являются управляемыми, но это скорее идеологическое, а не техническое ограничение.


### Resource: абстрактный ресурс в игровом мире
- title: string //название
- storable: bool //накапливается ли ресурс
- countable: bool //счетный ли ресурс

### Resource Stash: конкретная кучка конкретных ресурсов
Это runtime-объект. Он описывает, какие ресурсы лежат в конкретном юните прямо сейчас. В шаблоне используется ResourceStorage
- resource: Resource
- quantity: number

### Resource Storage: хранилище ресурсов
Эта структура описывает потенциальную возможность юнита или области хранить тот или иной тип ресурсов
- availableResourceTypes: [Resource]
- storageSize: number

### Area: Область
- geometry: AreaGeometry (?)
- effects: [Effect]
- storage: [ResourceStorage]
- traversable: bool //проходима ли по-умолчанию

### Requirement: требования за какое либо действие
- resource: [Resource]
- amount: number
- sourceType: (global, local, area) //откуда вычитаются ресурсы
- failureEffects: [Effect]


### Effect: Эффект
#### Common

- title: string //idenitifer for stacking
- class: string //класс эффекта. может быть использован дя реализации разных типов урона
- probability: number
- delay: number
- duration: number //time interval for which non-permanent effect lasts
- recurring: bool //should be duplicated and reapplied after expiring
- permanent: bool //should stats be restored after effext expires

Перманентный эффект просто меняет параметр конкретного юнита. Неперманентный эффект добавляется в стек активных эффектов данного юнита и при каждом изменении этого стека происходит перерасчет параметров конкретного юнита.

#### ValueModificatorEffect
- parameterPath: string
- amount: number
- multiplier: number
- stackable: bool

newValue = oldValue * multiplier + amount. Используя multiplier == 0, можно просто жестко устанавливать необходимое значение.

Задел на будущее - возможность различных типов эффектов. Пока что ограничимся изменением параметров с помощью математических формул. Хотя, например, эффект "клонирование юнита" наложенный на выход из состояния "мутация" позволяет вылупить двух зерглингов из яйца, вместо одного.





### Unit
-
Юнит имеет дефолтное состояние. Состояние имеет смежные состояния, куда можно перейти за определенную стоимость, плюс шаблон параметров юнита, соответствующий данному состоянию.

### Шаблон параметров юнита

Подструктуры
#### MovementSettings
- minSpeed: number
- maxSpeed: number
- maxAcceleration: number
- maxAngularSpeed: number
- traversable: bool //могут ли другие юниты проходить сквозь данный

#### WeaponTemplate
Два подхода к реализации разделения по классам "земля"-"воздух": 

1. "физическое" оружие, где невозможность поражения воздушных целей определяется лимитами углов наводки
2. availableTargetClasses: список классов возможных целей. 

- minHeading: number
- maxHeading: number
- minPitch: number
- maxPitch: number
- maxAngularSpeed: number
- aimingTime: number
- reloadTime: number
- targetingRadius: number
- projectile: ProjectileTemplate

#### ProjectileTemplate
- projectileType: type (?)
- associatedUnitTemplate: UnitTemplate
- effects: [Effect]

#### ProductionOrderTemplate
- requirements: [Requirement]
- duration: number
- maximumDeploymentRadius: number
- result: [UnitTemplate]

#### Ability Template
- title: string
- requirements: [Requirement]
- effects: [Effect]

-

#### UnitParametersTemplate
- maximumHealth: number
- accessibleLandscapeTypes: [LandscapeType]
- defaultMovement: MovementSettings
- movementOverrides: {Area: MovementSettings}
- weapons: [Weapon] //weapon instance based on weapon template
- storage: [ResourceStorage]
- destructionEffects: [Effect]

### UnitStateTemplate
- title: string
- unitParameters: UnitParametersTemplate
- supplyRequirements: [Requirement]
- accessibleStates: [UnitStateTemplate]
- inboundEffects: [Effect] //effects activated when entering state
- outboundEffects: [Effect] //effects activated when leaving state
- inboundRequirements: [Requirement] //supply requirements to enter state
- outboundRequirements: [Requirement] //supply requirements to exit state
- inboundTime: number
- outboundTime: number

### UnitTemplate
- title: string
- defaultState: UnitStateTemplate
- spawnEffects: [Effect]
- controllable: bool
- inspectable: bool //можем ли мы выделить этот юнит. Мы не можем выделить выстрел драгуна, но можем выделить выстрел ривера.

### Unit
Это непосредственно игровой юнит. Он имеет реальные параметры, свойственные конкретному экземпляру. Часть свойств принадлежит в общем случае игровому объекту выбранного движка, но я их все равно выпишу сюда для полноты картины.
Струкрута юнита в целом повторяет структуру и вложенность шаблона юнита и его подшаблонов, но я все пишу в плоском виде, чтобы на данном этапе не плохить сущностей

- template: UnitTemplate
- position: vector
- speed: vector //может не совпадать с ориентацией во время совершения поворота
- orientation: vector
- targetOrientation: vector
- storage: [ResourceStorage] 
- owner: Player(?)
- activeEffects: [EffectInProgress]
- activeWeapons: [Weapon] //оружие, соответствующее выбранному состоянию. Weapon и WeaponTemplate соотносятся точно так же, как Unit и UnitTemplate


Теперь о юнитах. Большинство юнитов-не-зданий реализуется с помощью темплейта, имеющего единственное состояние и единственное оружие. Пехотинец стреляет только вперед, драгун - в любую сторону: реализуется допустимыми углами поворота оружия. Осадный танк в обычном режиме стреляет куда угодно, но требует время на поворот башни - реализуется конечной угловой скоростью оружия. Осадный режим осадного танка - разные состояния. Мутации зергов - состояния (относительная некрасивость только с тем, что у зергов по сути один юнит - ларва с гигантской стейт-машиной). Раскладывание MCV в construction yard - состояния. Летающие здания терран - состояния. Кристаллы - юнит с хранилищем кристаллов, откуда дрон перекладывает их в свое хранилище, затем относит в хранилище командного центра, а тот перекидывает их в хранилище игрока. Депоты генерируют нехранимый ресурс "supply", а у юнитов он находится в requirements. Негативных эффектов при нехватке нет, но постройка нового юнита будет невозможна.
Пока что у меня совершенно не описана возможность хранить одни юниты внутри других - отпадают бункеры, огурцы, транспортники и вот это все. И я не совсем понимаю, как в рамках того, что я описал, лучше всего реализовать передачу ресурсов между юнитами в отрыве от атаки. Хотя на самом деле у SCV может быть два оружия - одно только наносит ущерб, но таргетится только на врага, другое не наносит ущерб, но забирает кристаллы, и таргетится только на нейтральные юниты. (а если бы таргетилось на всех, то можно было бы пиздить ресурсы из вражеских хранилищ лол)